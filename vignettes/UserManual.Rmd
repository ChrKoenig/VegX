---
title: "Using the VegX package"
author: "IAVS Ecoinformatics Working Group"
date: "`r Sys.Date()`"
output: 
  rmarkdown::html_vignette:
    css: mystyle.css
    toc: TRUE
vignette: >
  %\VignetteIndexEntry{VegX package user's manual}
  %\VignetteEngine{knitr::rmarkdown}
  \usepackage[utf8]{inputenc}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## About this manual

In this vignette you will learn how to use the **VegX R package** to map, integrate and harmonize vegetation data having the Veg-X standard as data model underlying the whole process. For the examples, we use the example data sets provided in the package. If you do not know what the Veg-X standard is, please refer to vignette *The Veg-X standard and the VegX R package*.

```{r load VegX}
library(VegX)
```

## Creating and populating Veg-X documents

### Loading the source data into R

We begin by loading the data from the three data sets that we will use as examples:
```{r load source data}
data(mokihinui)
data(mtfyffe)
data(takitimu)
ls()
```
Each of the three data sets contains different tables, corresponding to plot location, site observations, taxon observations, ...

### Creating a new Veg-X document
Before mapping any data to the Veg-X standard, we need to create a new (empty) document for each data set, using ``newVegX()``:
```{r init}
moki_vegx = newVegX()
mtfyffe_vegx = newVegX()
taki_vegx = newVegX()
```
The output from ``print()`` command reveals that a Veg-X document is defined in R using a S4 class, each of the different *slots* being vectors of the main elements of the Veg-X document: 
```{r print}
print(moki_vegx)
```
Printing a Veg-X object will normally result in too much data shown in the console output. A much user-friendly information about the Veg-X document can be obtained using function ``summary()``, which tell us how many instances we have of each of the main elements:
```{r summary empty}
summary(moki_vegx)
```
Of course, ``moki_vegx`` is now empty (as are the other two documents). In the following sections we will progressively add content to them.

### Adding project, plot and observation dates
When using the VegX package, it is not important the order in which we introduce data to VegX documents, as elements are created as needed. We start inspecting the data in the data frame ``moki_site``:
```{r inspect data}
head(moki_site, 3)

```
The data frame has many columns, covering both plot shape, site topography... but the most important columns to parse are ``Plot``, ``Subplot`` and ``PlotObsStartDate``, because these specify the space and time context in which vegetation surveys were made. Other columns specify IDs, but these are specific to the data base where this data comes from, and Veg-X documents have their own internal IDs, so will not import them now. 

In order to import data into Veg-X documents, we always need a **mapping** *between the names of elements in the Veg-X standard and the names of columns in the data table used as input*. For example, in the following code we define that column ``"Project"`` in the source data table contains the information about the *projectTitle* in Veg-X, column ``"Plot"`` contains the information about the *plotName*  element, and so on:

```{r mapping}
mapping = list(projectTitle = "Project", plotName = "Plot", subPlotName = "Subplot",
               obsStartDate = "PlotObsStartDate", obsEndDate = "PlotObsStopDate")
```

Once the mapping is defined, we can import the data using ``addPlotObservations()``:

```{r add plot obs}
# Adds information about projects, plots and plot observations (no measurements yet)
moki_vegx = addPlotObservations(moki_vegx, moki_site, mapping = mapping)
```
The output the add function informs us of the steps that took place and which modified our Veg-X R object (note that we could store the result in a different object instead of replacing ``moki_vegx``). 25 plots were identified, all belonging to the same project, and one plot observation was read for each plot. If we call again the ``summary`` function we will see a change in the number of data elements:
```{r summary}
summary(moki_vegx)
```
Note that among the 25 plots there are 20 subplots (in fact, 4 for each parent plot). If we want to inspect, at any time, the information of a Veg-X document in more detail, we can use the function ``showElementTable``, indicating which of the main Veg-X elements we want to inspect:
```{r show plot obs}
head(showElementTable(moki_vegx, "plotObservation"),10)
```

Let's now do the same for the **Mt Fyffe forest data set**. Since it comes from the same data base, data table have similar column names and we will not show them again. In this case, however, there is no information about the sampling end date, only the start date. We modify our mapping accordingly and we call ``addPlotObservations()`` :
```{r add plot obs mtfyffe}
mapping = list(projectTitle = "Project", plotName = "Plot", subPlotName = "Subplot", 
               obsStartDate = "PlotObsStartDate")
mtfyffe_vegx = addPlotObservations(mtfyffe_vegx, mtfyffe_site, mapping)
summary(mtfyffe_vegx)
```
In this source data set there are many more subplots for each plot, and each plot/subplot was visited twice (in 1980 and 2007-2008). Moreover, each survey corresponds to a different project. Veg-X does not require projects to be equated to surveys, but in this data set it happens to be like this. We now turn our attention to the **Takitimu grassland data set**. 

```{r add plot obs taki}
mapping = list(projectTitle = "Project", plotName = "Plot", subPlotName = "Subplot", 
               obsStartDate = "PlotObsStartDate")
taki_vegx = addPlotObservations(taki_vegx, taki_site, mapping)
summary(taki_vegx)
```
According to this summary, the data set contains again 5 plots, but with no subplots, so even if we specified a map for subplots none was detected.

### Adding plot location

The next information that we would normally want to map is about the geographic location of plots (sampling dates were already mapped with ``addPlotObservations()``). We thus take a look at ``moki_loc`` data frame:
```{r inspect plot loc moki}
head(moki_loc, 3)
```
Locations are expressed using different coordinate systems, but the easiest and more common way of exchanging geographic information is through latitude and longitude. Hence we define a new mapping and use the function ``addPlotLocations()``:
```{r add plot loc moki}
mapping = list(plotName = "Plot", subPlotName = "Subplot",
               x = "Longitude", y = "Latitude")
moki_vegx = addPlotLocations(moki_vegx, moki_loc, mapping)
```
When defining the mapping also included ``Plot`` and ``Subplot``. This is important because otherwise the function does not know how to match coordinates with the plots already defined in ``moki_vegx``. The console output indicates that no new plots have been added (they were previously defined), but they would if we had started populating the Veg-X object using ``addPlotLocations()`` and an empty document. When can inspect the data recently entered using the following command:

```{r inspect plot loc res moki}
head(showElementTable(moki_vegx, "plot"),3)
```
When calling ``showElementTable()`` for plot elements we are shown the plot/subplot relationships. Note that subplots have no explicit coordinates associated to them (they are not given in ``moki_loc``). It is up to the user to provide them in the source data. We also parse the coordinates of the Mt Fyffe forest data set:
```{r add plot loc mtfyffe}
mtfyffe_vegx = addPlotLocations(mtfyffe_vegx, mtfyffe_loc, mapping)
```
Apparently, 10 records were parsed, but only five plots (excluding subplots) are available. Coordinate records are duplicated in ``mtfyffe_loc``, once for each survey. Function ``addPlotLocations()`` will always keep the last location records of each plot. Finally, we parse plot coordinates for the Takikimu grassland data set, realizing that they are lacking for one of the plots.

```{r add plot loc taki}
taki_vegx = addPlotLocations(taki_vegx, taki_loc, mapping)
```

### Adding plot geometry

By plot geometry, we refer to plot area, shape and dimensions. Veg-X allows different plot shapes, and each plot shape implies different dimensions. Plot geometry is specified using function ``addPlotGeometries()``, which like ``addPlotLocation()`` will replace any previous information. We start by looking at the plot geometry fields in the Mokihinui data table ``moki_site``:
```{r inspect plot geom moki}
names(moki_site)
table(moki_site$Shape)
```
After realizing that plot shapes are rectangular and both length and width are available, we define the following mapping for rectangular (or square) plots:
```{r mapping plot geom moki}
mapping = list(plotName = "Plot", subPlotName = "Subplot",
               area = "PlotArea", shape = "Shape",
               width = "PlotRectangleLength01", length = "PlotRectangleLength02")
```
Since plot area and plot dimensions are **measurements**, it is important to specify **measurement methods** (i.e. instruments) and **measurement scales** (i.e. measurement units) because this metadata decreases potential errors when pooling data from different sources. In the Veg-X standard, this information is specified via defining *method* and *attribute* elements, whereas the VegX package has a S4 class named ``VegXMethod`` that encapsulates both things. Users can define their own methods, but the package provides function ``predefinedMeasurementMethod()`` to easily define methods for the most common variables. 

After checking the units used in ``moki_site`` we define methods for plot area and plot dimensions using:
```{r define geom methods}
areaMethod = predefinedMeasurementMethod("Plot area/m2")
dimensionMethod = predefinedMeasurementMethod("Plot dimension/m")
```
We are now ready to import plot geometry using ``addPlotGeometries()``, where we specify both the mapping and the list of methods corresponding to the Veg-X element names of the mapping (i.e. ``area``, ``length`` and ``width`` for rectangular plots):
```{r add plot geom moki}
moki_vegx = addPlotGeometries(moki_vegx, moki_site, mapping,
              list(area = areaMethod, width = dimensionMethod, length = dimensionMethod))
head(showElementTable(moki_vegx, "plot"),3)
```
Like before, no new plots were added, as previous call functions had already defined them. In the call to ``showElementTable()`` we have now the plot geometry added to the plot location and plot/subplot relationships. Importing plot geometry for the Takitimu grassland data set is 
```{r add plot geom taki}
taki_vegx = addPlotGeometries(taki_vegx, taki_site, mapping,
              list(area = areaMethod, width = dimensionMethod, length = dimensionMethod))
head(showElementTable(taki_vegx, "plot"))
```
In the case of Mt Fyffe forest data set, shape is missing for many of plots. Other plots are circular but *radius* is not defined in the data frame. 

```{r inspect plot geom mtfyffe}
names(mtfyffe_site)
table(mtfyffe_site$Shape)
```
Hence, we define the following mapping, and a call ``addPlotGeometries()`` produces the following result:
```{r add plot geom mtfyffe}
mapping = list(plotName = "Plot", subPlotName = "Subplot",
               area = "PlotArea", shape = "Shape")
mtfyffe_vegx = addPlotGeometries(mtfyffe_vegx, mtfyffe_site, mapping,
                                 list(area = areaMethod))
head(showElementTable(mtfyffe_vegx, "plot"), 3)
```

### Adding site characteristics
To finish with static plot information, the next data we should add to our Veg-X documents is plot topography. This can be done using function ``addSiteCharacteristics()``. Having inspected data frame ``moki_site`` before makes us suspect that a following mapping is:
```{r mapping site topo moki}
sitemapping = list(plotName = "Plot", subPlotName = "Subplot",
                   slope = "PlotSlope", aspect = "PlotAspect")

```
Since slope and aspect are measurements, we also need to provide methods for them. After checking the units in the source data we define the following methods:
```{r methods site topo moki}
slopeDeg = predefinedMeasurementMethod("Slope/degrees")
aspectDeg = predefinedMeasurementMethod("Aspect/degrees")
```
and we are ready to import the data:
```{r add site topo moki}
moki_vegx = addSiteCharacteristics(moki_vegx, moki_site, mapping = sitemapping,
                measurementMethods = list(slope = slopeDeg, aspect = aspectDeg))

head(showElementTable(moki_vegx, "plot"), 3)
```
Again, no new plots are added, and missing values correspond to subplots. When calling ``showElementTable()`` the topography information is shown along with the plot information previously added. Since the site data frames for Mt Fyffe forest and Takitimu grassland data sets have the same structure as that of Mokihinui, adding topography information for the former data sets is rather straightforward:

```{r add site topo mtfyffe}
mtfyffe_vegx = addSiteCharacteristics(mtfyffe_vegx, mtfyffe_site, mapping = sitemapping,
                measurementMethods = list(slope = slopeDeg, aspect = aspectDeg))
taki_vegx = addSiteCharacteristics(taki_vegx, taki_site, mapping = sitemapping,
                measurementMethods = list(slope = slopeDeg, aspect = aspectDeg))
```

### Adding aggregate organism observations

Aggregate organism observations include measurements that apply to a set of organisms simultaneously. The most common examples are abundance values (e.g. cover) for species. Function ``addAggregateOrganismObservations()`` can be used to import such data into a VegX document. We first inspect the data frame ``moki_tcv``:
```{r inspect taxon obs moki}
head(moki_tcv,3)
```
Taxon names can be drawn from column ``PreferredSpeciesName``, column ``Tier`` contains information about the stratum where species were recorded, whereas column ``Category`` contains cover values codified in a cover ordinal scale. First we define a mapping for these variables as well as for plot and observation start date, which together specify a *plotObservation* (subplots are not considered here).
```{r mapping taxon obs moki}
mapping = list(plotName = "Plot", obsStartDate = "PlotObsStartDate", 
               authorTaxonName = "PreferredSpeciesName",
               stratumName = "Tier", cover = "Category")
```
In order to parse cover values, we need to define an ordinal scale that can be used to interpret values, this can be used with function ``defineOrdinalScaleMethod()``:
```{r cover scale def}
coverscale = defineOrdinalScaleMethod(name = "Recce cover scale",
                   description = "Recce recording method by Hurst/Allen",
                   subject = "plant cover",
                   citation = "Hurst, JM and Allen, RB. (2007) The Recce method for describing 
                               Zealand vegetation – Field protocols. Landcare Research, Lincoln.",
                   codes = c("P","1","2","3", "4", "5", "6"),
                   quantifiableCodes = c("1","2","3", "4", "5", "6"),
                   breaks = c(0, 1, 5, 25, 50, 75, 100),
                   midPoints = c(0.05, 0.5, 15, 37.5, 62.5, 87.5),
                   definitions = c("Presence", "<1%", "1-5%","6-25%", "26-50%", 
                                   "51-75%", "76-100%"))
```
Since the source data includes
```{r moki strata def}
moki_strataDef = defineMixedStrata(name = "Recce strata",
                   description = "Standard Recce stratum definition",
                   citation = "Hurst, JM and Allen, RB. (2007) The Recce method for describing 
                               Zealand vegetation – Field protocols. Landcare Research, Lincoln.",
                   heightStrataBreaks = c(0, 0.3,2.0,5, 12, 25, 50),
                   heightStrataNames = paste0("Tier ",1:6),
                   categoryStrataNames = "Tier 7",
                   categoryStrataDefinition = "Epiphytes")
```


```{r add taxon obs moki}
moki_vegx = addAggregateOrganismObservations(moki_vegx, moki_tcv, mapping,
                        methods = c(cover=coverscale),
                        stratumDefinition = moki_strataDef)
head(showElementTable(moki_vegx, "aggregateOrganismObservation"),3)
```




```{r mapping taxon obs mtfyffe}
head(mtfyffe_counts, 3)
mapping = list(plotName = "Plot", subPlotName = "Subplot", obsStartDate = "PlotObsStartDate", 
               authorTaxonName = "PreferredSpeciesName", stratumName = "Tier", counts = "Value")
```

```{r count scale def}
countscale = predefinedMeasurementMethod("Plant counts")
```

```{r mtfyffe strata def}
mtfyffe_strataDef = defineHeightStrata(name = "Standard seedling/sapling strata",
                              description = "Seedling/sapling stratum definition",
                              heightBreaks = c(0, 15, 45, 75, 105, 135, 200),
                              strataNames = as.character(1:6),
                              strataDefinitions = c("0-15 cm", "16-45 cm", "46-75 cm", 
                                                    "76-105 cm", "106-135 cm", "> 135 cm"))
```


```{r add taxon obs mtfyffe}
mtfyffe_vegx = addAggregateOrganismObservations(mtfyffe_vegx, mtfyffe_counts, mapping,
                        methods = c(counts=countscale),
                        stratumDefinition = mtfyffe_strataDef)
head(showElementTable(mtfyffe_vegx, "aggregateOrganismObservation"),3)
```


```{r mapping taxon obs taki}
head(taki_freq, 3)
mapping = list(plotName = "Plot", subPlotName = "Subplot", obsStartDate = "PlotObsStartDate", 
               authorTaxonName = "PreferredSpeciesName", freq = "Value")
```

```{r freq scale def}
freqscale = predefinedMeasurementMethod("Plant frequency/%")
```


```{r add taxon obs taki}
taki_vegx = addAggregateOrganismObservations(taki_vegx, taki_freq, mapping,
                        methods = c(freq=freqscale))
head(showElementTable(taki_vegx, "aggregateOrganismObservation"), 3)
```

### Adding individual organism observations


```{r add ind obs moki}
mapping = list(plotName = "Plot", subPlotName = "Subplot", obsStartDate = "PlotObsStartDate",
               authorTaxonName = "PreferredSpeciesName", diameterMeasurement = "Diameter")

diamMeth = predefinedMeasurementMethod("DBH/cm")

moki_vegx = addIndividualOrganismObservations(moki_vegx, moki_dia, mapping = mapping,
                                      methods = c(diameterMeasurement = diamMeth))

head(showElementTable(moki_vegx, "individualOrganismObservation"), 3)
```



```{r add ind obs mtfyffe}
mapping = list(plotName = "Plot", subPlotName = "Subplot", obsStartDate = "PlotObsStartDate",
               authorTaxonName = "PreferredSpeciesName", individualOrganismLabel = "Identifier", 
               diameterMeasurement = "Diameter")

mtfyffe_vegx = addIndividualOrganismObservations(mtfyffe_vegx, mtfyffe_dia, 
                                  mapping = mapping,
                                  methods = c(diameterMeasurement = diamMeth))

head(showElementTable(mtfyffe_vegx, "individualOrganismObservation"), 3)
```

### Adding stratum observations

```{r add str obs moki}
mapping = list(plotName = "Plot", obsStartDate = "PlotObsStartDate", stratumName = "Tier",
               lowerLimitMeasurement = "TierLower", upperLimitMeasurement = "TierUpper",
               cover = "CoverClass")

heightMethod = predefinedMeasurementMethod("Stratum height/m")

moki_vegx = addStratumObservations(moki_vegx, moki_str, mapping = mapping,
                        methods = list(lowerLimitMeasurement = heightMethod,
                                       upperLimitMeasurement = heightMethod,
                                       cover=coverscale),
                        stratumDefinition = moki_strataDef)

head(showElementTable(moki_vegx, "stratumObservation"), 3)
```

### Adding surface cover observations

```{r add surface obs mtfyffe}
head(mtfyffe_groundcover, 3)
mapping = list(plotName = "Plot", obsStartDate = "PlotObsStartDate",
               surfaceName = "PlotGroundCover", coverMeasurement = "Value")

coverMethod = predefinedMeasurementMethod("Surface cover/%")

unique(mtfyffe_groundcover$PlotGroundCover)
surfaceTypes = defineSurfaceTypes(name = "Default surface types",
                     description = "Five surface categories",
                     surfaceNames = c("Vegetation", "Moss", "Litter", "Exposed Soil", 
                                      "Rock"))

mtfyffe_vegx = addSurfaceCoverObservations(mtfyffe_vegx, mtfyffe_groundcover, mapping,
                                coverMethod, surfaceTypes)

head(showElementTable(mtfyffe_vegx, "surfaceCoverObservation", 3))
```

```{r add surface obs taki}
head(taki_groundcover, 3)
unique(taki_groundcover$PlotGroundCover)
surfaceTypes = defineSurfaceTypes(name = "Default surface types",
                     description = "Five surface categories",
                     surfaceNames = c("Vegetation", "Soil", "Erosion Pavement", "Litter",
                                      "Rock"))

taki_vegx = addSurfaceCoverObservations(taki_vegx, taki_groundcover, mapping,
                                coverMethod, surfaceTypes)

head(showElementTable(taki_vegx, "surfaceCoverObservation"), 3)
```


### Adding site observations

```{r add site obs moki}
# mapping = list(plotName = "Plot", subPlotName = "Subplot", obsStartDate = "PlotObsStartDate")
# pHMeth = predefinedMeasurementMethod("pH")
# moki_vegx = addSiteObservations(moki_vegx, moki_site,
#                         plotObservationMapping = mapping,
#                         soilMeasurementMapping = list(pH = "pH"),
#                         soilMeasurementMethods = list(pH = pHMeth))
# head(showElementTable(moki_vegx, "siteObservation"))
```

## Combining Veg-X documents

```{r merge two documents}
# comb_vegx = mergeVegX(moki_vegx, mtfyffe_vegx)
# summary(comb_vegx)
```


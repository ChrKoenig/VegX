---
title: "Using the VegX package"
author: "IAVS Ecoinformatics Working Group"
date: "`r Sys.Date()`"
output: 
  rmarkdown::html_vignette:
    css: mystyle.css
vignette: >
  %\VignetteIndexEntry{Veg-X standard documentation}
  %\VignetteEngine{knitr::rmarkdown}
  \usepackage[utf8]{inputenc}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## About this manual

In this vignette you will learn how to use the **VegX R package** to integrate and harmonize vegetation data. For the examples, we use the example data sets provided in the package. If you do not know what Veg-X is, please refer to vignette *The Veg-X standard and the VegX R package*.

```{r load VegX}
library(VegX)
```

## Creating and populating Veg-X documents

### Loading the source data into R

We begin by loading the data from the two data sets that we will use as examples:
```{r load source data}
data(mokihinui)
data(mtfyffe)
ls()
```
Each of the two data sets contains different tables, corresponding to plot location, site observations, taxon observations, ...:

### Creating a new Veg-X document
Before mapping any data to the Veg-X standard, we need to create a new (empty) document, using ``newVegX()``:
```{r init}
moki_vegx = newVegX()
print(moki_vegx)
```
The output from ``print()`` command reveals that Veg-X objects are defined using S4 classes, each of the different slots corresponding to the main elements of Veg-X documents. Printing the Veg-X object will normally result in too much data shown in the console output. A much user-friendly information about the Veg-X document can be obtained using function ``summary()``, which tell us how many instances we have of each of the main elements:
```{r summary empty}
summary(moki_vegx)
```


### Adding project, plot and observation dates

```{r inspect data}
head(moki_site)

```
To import data into Veg-X documents, we often need a **mapping** between the names of elements in the Veg-X standard and the names of columns in the data table used as input. For example, in the following code we define that column ``"Project"`` in the source data table contains the information about the *projectTitle* in Veg-X, column ``"Plot"`` contains the information about the *plotName*  element, and so on:

```{r mapping}
mapping = list(projectTitle = "Project", plotName = "Plot", subPlotName = "Subplot",
               obsStartDate = "PlotObsStartDate", obsEndDate = "PlotObsStopDate")
```

Once the mapping is defined, we can import the data using ``addPlotObservations()``:

```{r add plot obs}
# Adds information about projects, plots and plot observations (no measurements yet)
moki_vegx = addPlotObservations(moki_vegx, moki_site, mapping = mapping)
```
The output the add function informs us of the steps that took place and which modified our Veg-X R object (note that we could store the result in a different object instead of replacing ``moki_vegx``). 25 plots were identified, all belonging to the same project, and one plot observation was read for each plot. If we call again the ``summary`` function we will see a change in the number of data elements:
```{r summary}
summary(moki_vegx)
```
If we want to inspect, at any time, the information of a Veg-X document, we can use the function ``showElementTable``, indicating which of the main Veg-X elements we want to inspect:
```{r show plot obs}
head(showElementTable(moki_vegx, "plotObservation"),10)
```

Let's now do the same for the **Mt Fyffe data set**. Since it comes from the same data base, data table have similar column names. In this case, however, there is no information about the sampling end date, only the start date. We modify our mapping accordingly and we call ``addPlotObservations()`` while creating an empty project as the target document:
```{r add plot obs mtfyffe}
mapping = list(projectTitle = "Project", plotName = "Plot", subPlotName = "Subplot", 
               obsStartDate = "PlotObsStartDate")
mtfyffe_vegx = addPlotObservations(newVegX(), mtfyffe_site, mapping)
summary(mtfyffe_vegx)
```
In this source data set there are many more subplots for each plot, and each plot/subplot was sampled twice (in 1980 and 2007-2008). Moreover, each survey corresponds to a different project. Veg-X does not require projects to be equated to surveys, but in this case it happens to be like this.

### Adding plot location

```{r add plot loc moki}
mapping = list(plotName = "Plot", subPlotName = "Subplot",
               x = "Longitude", y = "Latitude")
moki_vegx = addPlotLocations(moki_vegx, moki_loc, mapping)
head(showElementTable(moki_vegx, "plot"))
```


```{r add plot loc mtfyffe}
mtfyffe_vegx = addPlotLocations(mtfyffe_vegx, mtfyffe_loc, mapping)
head(showElementTable(mtfyffe_vegx, "plot"))
```

### Adding site characteristics


```{r add site topo moki}
sitemapping = list(plotName = "Plot", subPlotName = "Subplot",
                   slope = "PlotSlope", aspect = "PlotAspect")

slopeDeg = predefinedMeasurementMethod("Slope/degrees")
aspectDeg = predefinedMeasurementMethod("Aspect/degrees")

moki_vegx = addSiteCharacteristics(moki_vegx, moki_site, mapping = sitemapping,
                measurementMethods = list(slope = slopeDeg, aspect = aspectDeg))

head(showElementTable(moki_vegx, "plot"))
```


```{r add site topo mtfyffe}
mtfyffe_vegx = addSiteCharacteristics(mtfyffe_vegx, mtfyffe_site, mapping = sitemapping,
                measurementMethods = list(slope = slopeDeg, aspect = aspectDeg))

```


### Adding taxon observations

```{r mapping taxon obs moki}
head(moki_tcv)
mapping = list(plotName = "Plot", obsStartDate = "PlotObsStartDate", authorTaxonName = "PreferredSpeciesName",
               stratumName = "Tier", cover = "Category")
```

```{r cover scale def}
coverscale = defineOrdinalScaleMethod(name = "Recce cover scale",
                   description = "Recce recording method by Hurst/Allen",
                   subject = "plant cover",
                   citation = "Hurst, JM and Allen, RB. (2007) The Recce method for describing 
                               Zealand vegetation – Field protocols. Landcare Research, Lincoln.",
                   codes = c("P","1","2","3", "4", "5", "6"),
                   quantifiableCodes = c("1","2","3", "4", "5", "6"),
                   breaks = c(0, 1, 5, 25, 50, 75, 100),
                   midPoints = c(0.05, 0.5, 15, 37.5, 62.5, 87.5),
                   definitions = c("Presence", "<1%", "1-5%","6-25%", "26-50%", "51-75%", "76-100%"))
```

```{r moki strata def}
moki_strataDef = defineMixedStrata(name = "Recce strata",
                              description = "Standard Recce stratum definition",
                              citation = "Hurst, JM and Allen, RB. (2007) The Recce method for describing 
                                          Zealand vegetation – Field protocols. Landcare Research, Lincoln.",
                              heightStrataBreaks = c(0, 0.3,2.0,5, 12, 25, 50),
                              heightStrataNames = paste0("Tier ",1:6),
                              categoryStrataNames = "Tier 7",
                              categoryStrataDefinition = "Epiphytes")
```


```{r add taxon obs moki}
moki_vegx = addAggregateOrganismObservations(moki_vegx, moki_tcv, mapping,
                        methods = c(cover=coverscale),
                        stratumDefinition = moki_strataDef)
```




```{r mapping taxon obs mtfyffe}
head(mtfyffe_counts)
mapping = list(plotName = "Plot", subPlotName = "Subplot", obsStartDate = "PlotObsStartDate", 
               authorTaxonName = "PreferredSpeciesName", stratumName = "Tier", counts = "Value")
```

```{r count scale def}
countscale = predefinedMeasurementMethod("Plant counts")
```

```{r mtfyffe strata def}
mtfyffe_strataDef = defineHeightStrata(name = "Standard seedling",
                              description = "Standard seedling stratum definition",
                              heightBreaks = c(0, 15, 45, 75, 105, 135, 200),
                              strataNames = as.character(1:6),
                              strataDefinitions = c("0-15 cm", "16-45 cm", "46-75 cm", "76-105 cm", "106-135 cm", "> 135 cm"))
```


```{r add taxon obs mtfyffe}
mtfyffe_vegx = addAggregateOrganismObservations(mtfyffe_vegx, mtfyffe_counts, mapping,
                        methods = c(counts=countscale),
                        stratumDefinition = mtfyffe_strataDef)
```

### Adding individual organism observations


```{r add ind obs moki}
mapping = list(plotName = "Plot", subPlotName = "Subplot", obsStartDate = "PlotObsStartDate",
               authorTaxonName = "PreferredSpeciesName", diameterMeasurement = "Diameter")

diamMeth = predefinedMeasurementMethod("DBH/cm")

moki_vegx = addIndividualOrganismObservations(moki_vegx, moki_dia, mapping = mapping,
                                      methods = c(diameterMeasurement = diamMeth))

summary(moki_vegx)
head(showElementTable(moki_vegx, "individualOrganismObservation"))
```



```{r add ind obs mtfyffe}
mapping = list(plotName = "Plot", subPlotName = "Subplot", obsStartDate = "PlotObsStartDate",
               authorTaxonName = "PreferredSpeciesName", identificationLabel = "Identifier", diameterMeasurement = "Diameter")

mtfyffe_vegx = addIndividualOrganismObservations(mtfyffe_vegx, mtfyffe_dia, mapping = mapping,
                                      methods = c(diameterMeasurement = diamMeth))

summary(mtfyffe_vegx)
head(showElementTable(mtfyffe_vegx, "individualOrganismObservation"))
```

### Add stratum observations

```{r add str obs moki}
mapping = list(plotName = "Plot", obsStartDate = "PlotObsStartDate", stratumName = "Tier",
               lowerLimitMeasurement = "TierLower", upperLimitMeasurement = "TierUpper",
               cover = "CoverClass")

heightMethod = predefinedMeasurementMethod("Stratum height/m")

moki_vegx = addStratumObservations(moki_vegx, moki_str, mapping = mapping,
                        methods = list(lowerLimitMeasurement = heightMethod,
                                       upperLimitMeasurement = heightMethod,
                                       cover=coverscale),
                        stratumDefinition = moki_strataDef)

# Examine results
head(showElementTable(moki_vegx, "stratumObservation"))
```


### Add site observations

```{r add site obs moki}
mapping = list(plotName = "Plot", subPlotName = "Subplot", obsStartDate = "PlotObsStartDate")
pHMeth = predefinedMeasurementMethod("pH")
moki_vegx = addSiteObservations(moki_vegx, moki_site,
                        plotObservationMapping = mapping,
                        soilMeasurementMapping = list(pH = "pH"),
                        soilMeasurementMethods = list(pH = pHMeth))
head(showElementTable(moki_vegx, "siteObservation"))
```

## Combining Veg-X documents
# ```{r merge two documents}
# comb_vegx = mergeVegX(moki_vegx, mtfyffe_vegx)
# summary(comb_vegx)
# ```

